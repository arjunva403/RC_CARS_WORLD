<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - RC WORLD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rc-red': '#df2f2f',
                        'rc-dark-red': '#C62828',
                        'rc-cyan': '#00cbf8',
                        'rc-gray': '#8b8b8b',
                        'rc-light-gray': '#f1eded',
                        'rc-border-gray': '#d9d9d9',
                        'rc-yellow': '#fbd300',
                        'rc-star-filled': '#FFC107',
                        'rc-star-empty': '#E0E0E0',
                        'rc-success': '#28a745',
                        'rc-error': '#dc3545'
                    },
                    fontFamily: {
                        'aldrich': ['Aldrich', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Enhanced Animation Modal */
        .car-animation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.4s ease-out;
        }

        .car-animation-modal.show {
            display: flex;
        }

        .car-animation-container {
            text-align: center;
            color: white;
            max-width: 90%;
        }

        /* Enhanced Animation Track */
        .car-animation-toggle {
            width: 22em;
            height: 11em;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            margin: 0 auto 30px;
        }

        .car-animation-toggle::before,
        .car-animation-toggle::after {
            content: "";
            position: absolute;
            bottom: 0;
        }

        .car-animation-toggle::before {
            margin-left: -180px;
            width: inherit;
            height: 0.25em;
            background: linear-gradient(90deg, #f39c12, #e67e22);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
        }

        .car-animation-toggle::after {
            box-sizing: border-box;
            width: 50%;
            height: inherit;
            border: 0.25em solid #f39c12;
            border-radius: 50%;
            left: 25%;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
        }

        .car-animation-span {
            position: absolute;
            width: 15%;
            height: 25%;
            border-radius: 50%;
            bottom: 0.1em;
            left: -15%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: carRun 6s linear infinite, carRotating 6s linear infinite;
            transform-origin: 50% -2.7em;
        }

        .car-animation-span img {
            width: 100px;
            max-width: none;
        }


        /* Success/Error/Warning Indicators */
        .car-result-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5em;
            height: 5em;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .car-result-indicator.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.7);
        }

        .car-result-indicator.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.7);
        }

        .car-result-indicator.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.7);
        }

        .car-result-indicator.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.7);
        }

        .car-result-indicator.show {
            display: flex;
            animation: carIndicatorAppear 0.8s ease-out;
        }

        .car-icon {
            width: 2.5em;
            height: 2.5em;
            color: white;
            animation: carIconScale 0.6s ease-out 0.2s both;
        }

        /* Enhanced Status Message */
        .car-status-message {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.4s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .car-status-message h3 {
            margin: 0 0 15px 0;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 700;
        }

        .car-status-message.success h3 {
            color: #27ae60;
        }

        .car-status-message.error h3 {
            color: #e74c3c;
        }

        .car-status-message.warning h3 {
            color: #f39c12;
        }

        .car-status-message.info h3 {
            color: #3498db;
        }

        .car-status-message p {
            margin: 0;
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.4;
        }

        /* Action Buttons */
        .car-action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .car-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .car-btn.primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .car-btn.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .car-btn.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .car-btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .car-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Close Button */
        .car-close-button {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .car-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Loading Spinner */
        .car-loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4em;
            height: 4em;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .car-loading-spinner.show {
            display: block;
        }

        .car-svg {
            width: 5.5em;
            height: 5.5em;
            color: white;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        /* Animations */
        @keyframes carRun {
            0% {
                left: -15%;
            }

            10%,
            60% {
                left: calc((100% - 15%) / 2);
            }

            70%,
            100% {
                left: 100%;
            }
        }

        @keyframes carRotating {

            0%,
            10% {
                transform: rotate(0deg);
            }

            60%,
            100% {
                transform: rotate(-360deg);
            }
        }

        @keyframes carIndicatorAppear {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes carIconScale {
            0% {
                transform: scale(0) rotate(0deg);
            }

            50% {
                transform: scale(1.3) rotate(180deg);
            }

            100% {
                transform: scale(1) rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Input Field for Prompt */
        .car-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 15px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .car-input:focus {
            border-color: #3498db;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .car-animation-toggle {
                width: 18em;
                height: 9em;
            }

            .car-svg {
                width: 4.5em;
                height: 4.5em;
            }

            .car-action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>

<body class="bg-rc-light-gray font-aldrich text-gray-900">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[10000]"></div>
    <!-- Enhanced Car Animation Modal -->
    <div id="carAnimationModal" class="car-animation-modal">
        <button class="car-close-button" onclick="closeCarAnimation()">&times;</button>

        <div class="car-animation-container">
            <div id="carStatusMessage" class="car-status-message">
                <h3>üèÅ Processing...</h3>
                <p>Please wait while we process your request</p>
            </div>

            <div class="car-animation-toggle">
                <!-- Loading Spinner -->
                <div id="carLoadingSpinner" class="car-loading-spinner"></div>

                <!-- Result Indicators -->
                <div id="carResultIndicator" class="car-result-indicator">
                    <svg class="car-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Dynamic icon will be inserted here -->
                    </svg>
                </div>

                <div class="car-animation-span">
                    <img src="/images/image-from-rawpixel-id-6338436-png.png" alt="Car Icon">

                </div>
            </div>

            <!-- Action Buttons Container -->
            <div id="carActionButtons" class="car-action-buttons" style="display: none;">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-rc-red text-white relative z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center">
                    <a href="/login" class="ml-2 text-base font-aldrich hover:text-rc-light-gray transition-colors">

                        <div class="flex items-center gap-2">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                            <span class="hidden sm:inline">PROFILE</span>
                        </div>

                    </a>
                </div>
                <div class="text-center">
                    <h1 class="text-2xl font-bold font-aldrich">RC WORLD</h1>
                    <p class="text-sm">small wheels, big thrills</p>
                </div>
                <div class="flex items-center gap-2">
                    <a href="/cart" class="relative text-white hover:text-rc-light-gray transition-colors group"
                        aria-label="Shopping Cart">
                        <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="currentColor"
                            viewBox="0 0 24 24">
                            <path
                                d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                        </svg>
                        <span
                            class="absolute -top-2 -right-2 bg-white text-rc-red text-xs font-semibold w-5 h-5 rounded-full flex items-center justify-center cart-badge animate-pulse">
                            <%= totalItems && totalItems> 0 ? totalItems : 0 %>
                        </span>
                    </a>
                    <span class="text-sm hidden sm:inline">MY CART</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-black text-white relative z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center space-x-8 py-3">
                <a href="/" class="hover:text-rc-red font-aldrich text-base transition-colors">HOME</a>
                <a href="/products" class="hover:text-rc-red font-aldrich text-base transition-colors">PRODUCTS</a>
                <a href="/contact" class="hover:text-rc-red font-aldrich text-base transition-colors">CONTACT US</a>
                <a href="/about" class="hover:text-rc-red font-aldrich text-base transition-colors">ABOUT US</a>
                <a href="/profile" class="hover:text-rc-red font-aldrich text-base transition-colors">PROFILE</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumbs -->
    <div class="container mx-auto px-4 py-4">
        <nav aria-label="breadcrumb">
            <ol class="flex items-center text-sm bg-white p-3 rounded-md shadow-sm">
                <li class="mr-2"><a href="/" class="text-rc-gray hover:text-rc-red">Home</a></li>
                <li class="mr-2">/</li>
                <li class="mr-2"><a href="/cart" class="text-rc-gray hover:text-rc-red">Cart</a></li>
                <li class="mr-2">/</li>
                <li class="text-rc-gray">Checkout</li>
            </ol>
        </nav>
    </div>

    <!-- Checkout Section -->
    <main class="container mx-auto px-4 py-8">
        <h2 class="text-2xl font-semibold mb-8">Checkout</h2>
        <input type="hidden" id="userEmail" value="<%= user %>">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Section -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Cart Preview -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Your Cart</h3>
                    <% cartProduct.forEach(cartDoc=> { %>
                        <% cartDoc.items.forEach(element=> { %>
                            <div class="flex items-center justify-between gap-4 mb-4">
                                <div class="flex items-center gap-4 flex-1">
                                    <img src="<%= element.productId.images[0] %>"
                                        alt="<%= element.productId.productName %>"
                                        class="w-24 h-24 object-cover rounded-md">
                                    <div>
                                        <p class="text-base font-medium">
                                            <%= element.productId.productName %>
                                        </p>
                                        <p class="text-sm text-rc-gray">Quantity: <%= element.quantity %>
                                        </p>

                                        <!-- Enhanced Price Display with Offers -->
                                        <% if (element.applyOffer) { %>
                                            <!-- Show offer information -->
                                            <div class="offer-info mt-1">
                                                <div
                                                    class="offer-badge bg-red-500 text-white text-xs px-2 py-1 rounded-full inline-block mb-1">
                                                    <i class="fas fa-fire mr-1"></i>
                                                    <%= element.offerTitle %>
                                                </div>
                                                <div class="price-display flex items-center gap-2">
                                                    <span class="text-sm font-bold text-red-600">‚Çπ<%=
                                                            element.finalPrice.toLocaleString('en-IN') %></span>
                                                    <span class="text-xs text-gray-500 line-through">‚Çπ<%=
                                                            element.originalPrice.toLocaleString('en-IN') %></span>
                                                    <span class="text-xs text-green-600">
                                                        Save ‚Çπ<%= (element.originalPrice -
                                                            element.finalPrice).toLocaleString('en-IN') %>
                                                    </span>
                                                </div>
                                                <p class="text-xs text-green-600 mt-1">
                                                    <i class="fas fa-tag mr-1"></i>
                                                    <%= element.discountPercentage %>% off with <%= element.offerSource
                                                            %> offer!
                                                </p>
                                            </div>
                                            <% } else { %>
                                                <!-- No offer, show regular price -->
                                                <div class="price-info mt-1">
                                                    <span class="text-sm font-medium">‚Çπ<%=
                                                            element.productId.discountPrice.toLocaleString('en-IN') %>
                                                    </span>
                                                </div>
                                                <% } %>

                                                    <p class="text-sm text-rc-success">Arrives By <%= deliveryDate %>,
                                                            <%= year %>
                                                    </p>
                                                    <input type="hidden" id="peoductId"
                                                        data-id="<%= element.productId._id %>">
                                    </div>
                                </div>

                                <!-- Enhanced Total Display -->
                                <div class="text-right">
                                    <% if (element.applyOffer) { %>
                                        <!-- Show item total with offers -->
                                        <div class="text-base font-bold text-red-600">
                                            ‚Çπ<%= element.finalItemTotal.toLocaleString('en-IN') %>
                                        </div>
                                        <div class="text-sm text-gray-500 line-through">
                                            ‚Çπ<%= element.originalItemTotal.toLocaleString('en-IN') %>
                                        </div>
                                        <div class="text-xs text-green-600 font-medium">
                                            You Save: ‚Çπ<%= element.itemSavings.toLocaleString('en-IN') %>
                                        </div>
                                        <% } else { %>
                                            <!-- No offer, show regular total -->
                                            <div class="text-base font-bold">
                                                ‚Çπ<%= (element.productId.discountPrice *
                                                    element.quantity).toLocaleString('en-IN') %>
                                            </div>
                                            <% } %>
                                </div>
                            </div>
                            <% }) %>
                                <% }) %>

                                    <!-- Total Savings Summary -->
                                    <% if (typeof totalSavings !=='undefined' && totalSavings> 0) { %>
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-4">
                                            <div class="flex items-center text-green-800">
                                                <i class="fas fa-check-circle mr-2"></i>
                                                <span class="font-medium">You're saving ‚Çπ<%=
                                                        totalSavings.toLocaleString('en-IN') %> with offers!</span>
                                            </div>
                                        </div>
                                        <% } %>
                </div>

                <!-- Delivery Address -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Delivery Address</h3>
                    <% if (address.length> 0) { %>
                        <select id="addressSelect"
                            class="w-full p-3 border border-rc-border-gray rounded-md mb-4 focus:outline-none focus:border-rc-red"
                            onchange="updateSelectedAddress()">
                            <option value="0">Select an address</option>
                            <% address.forEach(addressDoc=> { %>
                                <% addressDoc.address.forEach((element, index)=> { %>
                                    <option value="<%= addressDoc._id %>-<%= index %>" <%=element.isDefault ? 'selected'
                                        : '' %>>
                                        <%= element.addressType %> - <%= element.name %>
                                                <%= element.isDefault ? '(Default)' : '' %>
                                    </option>
                                    <% }) %>
                                        <% }) %>
                        </select>
                        <% address.forEach(addressDoc=> { %>
                            <% addressDoc.address.forEach((element, index)=> { %>
                                <div id="address-<%= addressDoc._id %>-<%= index %>"
                                    class="address-details hidden mb-4 p-4 bg-rc-light-gray rounded-md">
                                    <p class="font-medium"><strong>
                                            <%= element.name %>
                                        </strong> (<%= element.addressType %>)</p>
                                    <p class="text-sm text-rc-gray">
                                        <%= element.houseNo %>, <%= element.locality %><br>
                                                <%= element.city %>, <%= element.state %> - <%= element.pincode %><br>
                                                            Phone: <%= element.phoneNumber %>
                                                                <% if (element.altPhoneNumber) { %>
                                                                    <br>Alt. Phone: <%= element.altPhoneNumber %>
                                                                        <% } %>
                                                                            <% if (element.landMark) { %>
                                                                                <br>Landmark: <%= element.landMark %>
                                                                                    <% } %>
                                                                                        <% if (element.isDefault) { %>
                                                                                            <br><span
                                                                                                class="text-rc-success">Default
                                                                                                Address</span>
                                                                                            <% } %>
                                    </p>
                                    <input type="hidden" id="userPhone" value="<%= element.phoneNumber %>">
                                </div>
                                <% }) %>
                                    <% }) %>
                                        <% } else { %>
                                            <p class="text-sm text-rc-gray mb-4">No addresses found. Please add a new
                                                address.</p>
                                            <% } %>

                                                <div class="flex flex-wrap gap-3">
                                                    <button
                                                        class="bg-rc-red text-white py-2 px-4 rounded-md font-medium hover:bg-rc-dark-red transition-colors"
                                                        onclick="showAddAddressForm()">+ Add New Address</button>
                                                    <button
                                                        class="bg-white border border-rc-red text-rc-red py-2 px-4 rounded-md font-medium hover:bg-rc-red hover:text-white transition-colors"
                                                        onclick="editSelectedAddress()">‚úé Edit Address</button>
                                                    <button
                                                        class="bg-white border border-rc-error text-rc-error py-2 px-4 rounded-md font-medium hover:bg-rc-error hover:text-white transition-colors"
                                                        onclick="removeSelectedAddress()">üóë Remove Address</button>
                                                </div>

                                                <!-- Address Form (keeping existing form structure) -->
                                                <div id="addressForm"
                                                    class="address-form hidden mt-4 p-4 bg-rc-light-gray rounded-md border border-rc-border-gray">
                                                    <!-- Personal Information Section -->
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Name *</label>
                                                            <input type="text" id="formName" placeholder="Full Name"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Phone Number
                                                                *</label>
                                                            <input type="tel" id="formPhone" placeholder="9876543210"
                                                                pattern="[0-9]{10}" maxlength="10"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                    </div>

                                                    <div class="grid grid-cols-1 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Alternate
                                                                Phone</label>
                                                            <input type="tel" id="formAltPhone" placeholder="9876543211"
                                                                pattern="[0-9]{10}" maxlength="10"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red">
                                                        </div>
                                                    </div>

                                                    <!-- Address Details Section -->
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Pincode
                                                                *</label>
                                                            <input type="text" id="formPin" placeholder="400001"
                                                                pattern="[0-9]{6}" maxlength="6"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">Locality/Area
                                                                *</label>
                                                            <input type="text" id="formLocality"
                                                                placeholder="Andheri West"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                    </div>

                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">House
                                                                No/Building *</label>
                                                            <input type="text" id="formHouseNo"
                                                                placeholder="Flat 12B, Royal Heights"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium mb-1">Landmark</label>
                                                            <input type="text" id="formLandMark"
                                                                placeholder="Near Infinity Mall"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red">
                                                        </div>
                                                    </div>

                                                    <!-- Location Information Section -->
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">State
                                                                *</label>
                                                            <select id="formState"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                                <option value="">Select State</option>
                                                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                                                <option value="Assam">Assam</option>
                                                                <option value="Bihar">Bihar</option>
                                                                <option value="Delhi">Delhi</option>
                                                                <option value="Gujarat">Gujarat</option>
                                                                <option value="Karnataka">Karnataka</option>
                                                                <option value="Kerala">Kerala</option>
                                                                <option value="Maharashtra">Maharashtra</option>
                                                                <option value="Punjab">Punjab</option>
                                                                <option value="Rajasthan">Rajasthan</option>
                                                                <option value="Tamil Nadu">Tamil Nadu</option>
                                                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                                <option value="West Bengal">West Bengal</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-sm font-medium mb-1">City *</label>
                                                            <input type="text" id="formCity" placeholder="Mumbai"
                                                                class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red"
                                                                required>
                                                        </div>
                                                    </div>

                                                    <!-- Address Type Section -->
                                                    <div class="mb-6">
                                                        <label class="block text-sm font-medium mb-2">Address Type
                                                            *</label>
                                                        <div class="grid grid-cols-3 gap-4">
                                                            <label
                                                                class="address-type-label flex items-center justify-center p-3 border-2 border-rc-border-gray rounded-lg cursor-pointer hover:border-rc-red hover:bg-rc-red/5 transition-all duration-200">
                                                                <input type="radio" name="formAddressType" value="home"
                                                                    class="mr-3" required>
                                                                <i class="fas fa-home text-xl mr-2 text-rc-gray"></i>
                                                                <span class="font-medium">Home</span>
                                                            </label>
                                                            <label
                                                                class="address-type-label flex items-center justify-center p-3 border-2 border-rc-border-gray rounded-lg cursor-pointer hover:border-rc-red hover:bg-rc-red/5 transition-all duration-200">
                                                                <input type="radio" name="formAddressType" value="work"
                                                                    class="mr-3" required>
                                                                <i
                                                                    class="fas fa-briefcase text-xl mr-2 text-rc-gray"></i>
                                                                <span class="font-medium">Work</span>
                                                            </label>
                                                            <label
                                                                class="address-type-label flex items-center justify-center p-3 border-2 border-rc-border-gray rounded-lg cursor-pointer hover:border-rc-red hover:bg-rc-red/5 transition-all duration-200">
                                                                <input type="radio" name="formAddressType" value="other"
                                                                    class="mr-3" required>
                                                                <i
                                                                    class="fas fa-ellipsis-h text-xl mr-2 text-rc-gray"></i>
                                                                <span class="font-medium">Other</span>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <!-- Action Buttons -->
                                                    <div class="flex flex-col sm:flex-row gap-4">
                                                        <button type="button" id="saveAddressBtn"
                                                            class="flex-1 bg-rc-red text-white py-3 px-6 rounded-lg font-semibold hover:bg-rc-red/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                                            <i class="fas fa-save mr-2"></i>
                                                            Save Address
                                                        </button>
                                                        <button type="button" id="cancelAddressBtn"
                                                            class="bg-rc-light-gray text-rc-gray py-3 px-6 rounded-lg font-semibold hover:bg-rc-border-gray transition-colors">
                                                            <i class="fas fa-times mr-2"></i>
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>


                                                <div class="mt-4">
                                                    <label for="recipientName"
                                                        class="block text-sm font-medium mb-1">Recipient Name (for
                                                        delivery):</label>
                                                    <input type="text" id="recipientName"
                                                        placeholder="Enter recipient's name"
                                                        class="w-full p-3 border border-rc-border-gray rounded-md focus:outline-none focus:border-rc-red">
                                                </div>
                </div>

                <!-- Payment Methods -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Payment Method</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="payment" value="razorpay" class="text-rc-red focus:ring-rc-red">
                            <span>Razorpay</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="payment" value="Wallet" class="text-rc-red focus:ring-rc-red">
                            <span>Wallet</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="payment" value="COD" class="text-rc-red focus:ring-rc-red">
                            <span>COD <small>(Cash on Delivery)</small></span>
                        </label>
                    </div>
                </div>

                <button
                    class="w-full bg-rc-red text-white py-3 rounded-md font-semibold hover:bg-rc-dark-red transition-colors"
                    onclick="placetheorder()">Place Your Order</button>
            </div>

            <!-- Right Section: Enhanced Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Order Summary</h3>
                    <div class="space-y-3">
                        <!-- Enhanced Summary with Offer Information -->
                        <% if (typeof subtotalOriginal !=='undefined' && subtotalOriginal> subtotal) { %>
                            <!-- Show original subtotal if offers are applied -->
                            <div class="flex justify-between text-sm">
                                <span>Original Subtotal:</span>
                                <span class="line-through text-gray-500">‚Çπ<%= subtotalOriginal.toLocaleString('en-IN')
                                        %></span>
                            </div>
                            <div class="flex justify-between text-sm text-green-600 font-medium">
                                <span>Offer Savings:</span>
                                <span>-‚Çπ<%= totalSavings.toLocaleString('en-IN') %></span>
                            </div>
                            <% } %>


                                <div class="flex justify-between text-sm">
                                    <span id="totalitems" data-items="<%= totalItems %>">
                                        <%= totalItems %> Item<%= totalItems> 1 ? 's' : '' %>
                                    </span>
                                    <span id="subtotal" data-subtotal="<%= subtotal %>">‚Çπ<%=
                                            subtotal.toLocaleString('en-IN') %></span>
                                </div>

                                <div class="flex justify-between text-sm">
                                    <span>Shipping Charges</span>
                                    <span id="ShippingCharge" data-shippingcharge="<%= ShippingCharge %>"
                                        class="<%= ShippingCharge === 0 ? 'text-green-600' : '' %>">
                                        <%= ShippingCharge===0 ? 'FREE' : '‚Çπ' + ShippingCharge.toLocaleString('en-IN')
                                            %>
                                    </span>
                                </div>
                                <div id="couponDiv" class="flex justify-between text-sm text-green-600 font-medium"
                                    style="display:none;">
                                    <span>Applied Coupon:</span>
                                    <span id="coupenAppled"></span>
                                </div>


                                <% if (discountAmount> 0) { %>
                                    <div class="flex justify-between text-sm text-green-600">
                                        <span>Additional Discount</span>
                                        <span id="discount-text" data-discountamount="<%= discountAmount %>">-‚Çπ<%=
                                                discountAmount.toLocaleString('en-IN') %></span>
                                    </div>
                                    <% } %>

                                        <div
                                            class="flex justify-between text-base font-bold border-t border-rc-border-gray pt-4 mt-4">
                                            <span>Total</span>
                                            <span id="total-price" data-total="<%= finalTotal %>" class="text-red-600">‚Çπ
                                                <%= finalTotal.toLocaleString('en-IN') %>
                                            </span>
                                        </div>
                    </div>

                    <!-- Total Savings Highlight -->
                    <% if (typeof totalSavings !=='undefined' && totalSavings> 0) { %>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-4">
                            <div class="flex items-center text-green-800">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span class="font-medium">You're saving ‚Çπ<%= totalSavings.toLocaleString('en-IN') %>
                                        with offers!</span>
                            </div>
                        </div>
                        <% } %>

                            <div class="mt-6">
                                <h4 class="text-base font-medium mb-2">Apply Coupon</h4>
                                <div class="flex">
                                    <input type="text" id="couponInput" placeholder="Enter coupon code"
                                        class="w-full p-3 border border-rc-border-gray rounded-l-md focus:outline-none focus:border-rc-red"
                                        aria-label="Coupon code">
                                    <button
                                        class="coupenButton bg-rc-red text-white px-4 py-3 rounded-r-md font-semibold hover:bg-rc-dark-red transition-colors"
                                        onclick="applyCoupon()" aria-label="Apply coupon">Apply</button>
                                </div>
                                <small id="couponMessage" class="text-rc-gray mt-2 block"></small>
                            </div>

                            <!-- Enhanced Coupons Display -->
                            <div id="allCouponsPanel" class="mt-4">
                                <h4 class="text-base font-medium mb-2">Available Coupons</h4>
                                <div class="bg-rc-red/90 rounded-md p-3">
                                    <div id="couponsScroller"
                                        class="flex gap-2 overflow-x-auto hide-scrollbar py-2 cursor-grab"
                                        aria-label="Available coupons" tabindex="0">
                                        <% coupen.forEach(coupon=> { %>
                                            <div class="coupon-chip bg-white rounded-full px-3 py-2 text-xs font-medium text-rc-red whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors"
                                                onclick="selectCoupon('<%= coupon.code %>')">
                                                <i class="fas fa-percent mr-1"></i>
                                                <%= coupon.code %>
                                                    <span class="text-green-600 ml-1">Save ‚Çπ<%= coupon.discount %>
                                                    </span>
                                            </div>
                                            <% }) %>
                                    </div>
                                </div>
                                <small id="allCouponsNote" class="text-gray-600 block mt-1 px-1">
                                    Tap a coupon to fill the code, then press Apply.
                                </small>
                            </div>

                            <button
                                class="w-full bg-rc-red text-white py-3 rounded-md font-semibold hover:bg-rc-dark-red transition-colors mt-6"
                                onclick="placetheorder()">Place Your Order</button>

                            <div class="mt-6">
                                <p class="text-sm font-medium mb-2">Accepted Payment Methods</p>
                                <div class="flex gap-2">
                                    <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" class="h-6">
                                    <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard"
                                        class="h-6">
                                    <img src="https://img.icons8.com/color/48/paytm.png" alt="Paytm" class="h-6">
                                </div>
                            </div>

                            <div class="mt-4 text-sm text-rc-gray">
                                <a href="/contact" class="block hover:text-rc-red transition-colors">Contact Us</a>
                                <a href="/delivery" class="block hover:text-rc-red transition-colors">Delivery</a>
                                <a href="/return" class="block hover:text-rc-red transition-colors">Return & Refund</a>
                                <a href="/promotions" class="block hover:text-rc-red transition-colors">Promotions &
                                    Vouchers</a>
                            </div>
                </div>
            </div>
        </div>
    </main>


    <!-- Recommended Products Section -->
    <section class="container mx-auto px-4 py-12 relative">
        <h2 class="text-2xl font-semibold mb-8 border-b-2 border-rc-border-gray pb-2">You May Also Like</h2>
        <div class="relative">
            <div class="flex overflow-x-auto gap-6 pb-4 hide-scrollbar" id="recommendCarousel">
                <% if (product) { %>
                    <% product.forEach(products=> { %>
                        <div
                            class="flex-shrink-0 w-64 bg-white border border-rc-border-gray rounded-lg shadow-sm p-4 text-center hover:-translate-y-1 hover:shadow-lg transition-all">
                            <a href="/details/<%= products._id %>">
                                <img src="<%= products.images[0] %>" alt="<%= products.productName %>"
                                    class="w-full h-40 object-contain mb-4">
                            </a>
                            <h3 class="font-medium text-sm mb-2 font-aldrich">
                                <%= products.productName %>
                            </h3>
                            <div class="star-rating flex justify-center gap-1 mb-2">
                                <% for(let i=0; i < 5; i++) { %>
                                    <span
                                        class="text-rc-star-<%= i < Math.floor(products.rating || 4) ? 'filled' : 'empty' %> text-lg">‚òÖ</span>
                                    <% } %>
                            </div>
                            <p class="text-lg font-bold mb-4">‚Çπ<%= products.discountPrice.toLocaleString() %>
                            </p>
                            <button
                                class="bg-rc-cyan text-white py-2 px-4 rounded-md text-sm font-semibold hover:bg-rc-cyan/90 transition-colors"
                                onclick="addToCart('<%= products._id %>')" aria-label="Add to cart">ADD TO CART</button>
                        </div>
                        <% }) %>
                            <% } %>
            </div>
            <button
                class="carousel-control absolute left-[-25px] top-1/2 -translate-y-1/2 bg-rc-red/70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-rc-red/90 hover:scale-110 transition-all z-30 prev"
                onclick="scrollCarousel('recommendCarousel', -300)" aria-label="Previous product">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button
                class="carousel-control absolute right-[-25px] top-1/2 -translate-y-1/2 bg-rc-red/70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-rc-red/90 hover:scale-110 transition-all z-30 next"
                onclick="scrollCarousel('recommendCarousel', 300)" aria-label="Next product">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </section>

    <!-- Features -->
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 bg-rc-light-gray rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-rc-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-black text-xl">EXPRESS SHIPPING</h3>
                        <p class="text-rc-gray">Shipping in 24 Hours</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 bg-rc-light-gray rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-rc-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-black text-xl">SHIPPING TRACKING</h3>
                        <p class="text-rc-gray">Online Order tracking available</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 bg-rc-light-gray rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-rc-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-black text-xl">BUY SAFELY</h3>
                        <p class="text-rc-gray">Buy safely, any question is here to help!</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-rc-light-gray py-16">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="font-bold text-black mb-6 text-lg">CUSTOMER SERVICE</h3>
                    <ul class="space-y-3 text-rc-gray">
                        <li><a href="/contact" class="hover:text-black transition-colors">Contact Us</a></li>
                        <li><a href="/return" class="hover:text-black transition-colors">Shipping & Returns</a></li>
                        <li><a href="/terms" class="hover:text-black transition-colors">Terms & Conditions</a></li>
                        <li><a href="/order" class="hover:text-black transition-colors">Delivery</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-black mb-6 text-lg">INFORMATION</h3>
                    <ul class="space-y-3 text-rc-gray">
                        <li><a href="/about" class="hover:text-black transition-colors">About Us</a></li>
                        <li><a href="/privacy" class="hover:text-black transition-colors">Privacy Policy</a></li>
                        <li><a href="/terms" class="hover:text-black transition-colors">Terms & Conditions</a></li>
                        <li><a href="/admin" class="hover:text-black transition-colors">Administrator</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-black mb-6 text-lg">FOLLOW US</h3>
                    <div class="flex gap-4">
                        <a href="#" class="text-rc-gray hover:text-black transition-colors" aria-label="Pinterest">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.174-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.097.118.112.221.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.402.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.357-.629-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24.009 12.017 24.009c6.624 0 11.99-5.367 11.99-11.988C24.007 5.367 18.641.001.012.001z" />
                            </svg>
                        </a>
                        <a href="#" class="text-rc-gray hover:text-black transition-colors" aria-label="Twitter">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z" />
                            </svg>
                        </a>
                        <a href="#" class="text-rc-gray hover:text-black transition-colors" aria-label="LinkedIn">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                            </svg>
                        </a>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-black mb-6 text-lg">CONTACT US</h3>
                    <div class="space-y-3 text-rc-gray">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                            </svg>
                            <span>(+91) 95551 76147</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                            </svg>
                            <span>info@email.com</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" />
                                <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                            </svg>
                            <span>8:00 - 21:00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-12 pt-8 border-t border-rc-border-gray">
                <div class="flex gap-6 items-center">
                    <div class="text-3xl font-bold text-rc-gray">VISA</div>
                    <div class="text-3xl font-bold text-rc-red">mastercard</div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function selectCoupon(couponCode) {
            document.getElementById('couponInput').value = couponCode;
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `flex items-center gap-2 px-5 py-3 mb-3 rounded-lg text-white font-medium shadow-lg opacity-0 transform -translate-y-5 transition-all duration-300 ${type === 'success' ? 'bg-rc-success' : 'bg-rc-error'}`;
            toast.innerHTML = `
        ${message}
        <button class="ml-auto text-white text-lg" onclick="this.parentElement.remove()">√ó</button>
    `;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('opacity-100', 'translate-y-0'));
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Car Animation Class - Complete SweetAlert Replacement
        class CarAlert {
            constructor() {
                this.modal = document.getElementById('carAnimationModal');
                this.statusMessage = document.getElementById('carStatusMessage');
                this.resultIndicator = document.getElementById('carResultIndicator');
                this.actionButtons = document.getElementById('carActionButtons');
                this.loadingSpinner = document.getElementById('carLoadingSpinner');
                this.currentCallback = null;
                this.autoCloseTimer = null;
            }

            // Main alert function (replaces Swal.fire())
            show(options = {}) {
                const {
                    type = 'info',
                    title = 'Alert',
                    text = '',
                    showConfirmButton = true,
                    showCancelButton = false,
                    confirmButtonText = 'OK',
                    cancelButtonText = 'Cancel',
                    timer = null,
                    showCloseButton = true,
                    allowOutsideClick = true,
                    input = null,
                    inputPlaceholder = '',
                    callback = null
                } = options;

                this.currentCallback = callback;
                this.clearTimers();

                // Reset states
                this.resultIndicator.classList.remove('show', 'success', 'error', 'warning', 'info');
                this.statusMessage.classList.remove('success', 'error', 'warning', 'info');
                this.loadingSpinner.classList.remove('show');

                // Set message content
                this.statusMessage.innerHTML = `
          <h3>${this.getIcon(type)} ${title}</h3>
          <p>${text}</p>
          ${input ? `<input type="text" class="car-input" id="carInput" placeholder="${inputPlaceholder}">` : ''}
        `;
                this.statusMessage.className = `car-status-message ${type}`;

                // Show modal
                this.modal.classList.add('show');

                // Setup buttons
                this.setupButtons(showConfirmButton, showCancelButton, confirmButtonText, cancelButtonText, type);

                // Show result indicator when car reaches destination
                setTimeout(() => {
                    this.resultIndicator.className = `car-result-indicator ${type} show`;
                    this.resultIndicator.innerHTML = this.getIconSVG(type);
                }, 3600);

                // Auto-close with timer
                if (timer) {
                    this.autoCloseTimer = setTimeout(() => {
                        this.close();
                    }, timer);
                }

                // Handle outside click
                if (!allowOutsideClick) {
                    this.modal.removeEventListener('click', this.outsideClickHandler);
                } else {
                    this.modal.addEventListener('click', this.outsideClickHandler.bind(this));
                }
            }

            // Setup action buttons
            setupButtons(showConfirm, showCancel, confirmText, cancelText, type) {
                this.actionButtons.innerHTML = '';

                if (showConfirm || showCancel) {
                    this.actionButtons.style.display = 'flex';

                    if (showCancel) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'car-btn secondary';
                        cancelBtn.textContent = cancelText;
                        cancelBtn.onclick = () => this.handleButtonClick(false);
                        this.actionButtons.appendChild(cancelBtn);
                    }

                    if (showConfirm) {
                        const confirmBtn = document.createElement('button');
                        confirmBtn.className = `car-btn ${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'}`;
                        confirmBtn.textContent = confirmText;
                        confirmBtn.onclick = () => this.handleButtonClick(true);
                        this.actionButtons.appendChild(confirmBtn);
                    }
                } else {
                    this.actionButtons.style.display = 'none';
                }
            }

            // Handle button clicks
            handleButtonClick(isConfirm) {
                let result = { isConfirmed: isConfirm };

                const input = document.getElementById('carInput');
                if (input) {
                    result.value = input.value;
                }

                if (this.currentCallback) {
                    this.currentCallback(result);
                }

                if (isConfirm && !input) {
                    // Auto-close after confirmation for simple alerts
                    setTimeout(() => this.close(), 1000);
                } else {
                    this.close();
                }
            }

            // Get emoji icon for type
            getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è',
                    question: '‚ùì'
                };
                return icons[type] || icons.info;
            }

            // Get SVG icon for type
            getIconSVG(type) {
                const icons = {
                    success: '<path stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M20 6L9 17l-5-5"/>',
                    error: '<path stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M18 6L6 18M6 6l12 12"/>',
                    warning: '<path stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                    info: '<path stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                    question: '<path stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                };

                return `<svg class="car-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          ${icons[type] || icons.info}
        </svg>`;
            }

            // Show loading state
            showLoading(title = 'üèÅ Loading...', text = 'Please wait while we process your request') {
                this.statusMessage.innerHTML = `<h3>${title}</h3><p>${text}</p>`;
                this.statusMessage.className = 'car-status-message info';
                this.actionButtons.style.display = 'none';
                this.resultIndicator.classList.remove('show');
                this.loadingSpinner.classList.add('show');
                this.modal.classList.add('show');
            }

            // Hide loading and show result
            hideLoading(type = 'success', title = 'Complete!', text = 'Operation completed successfully') {
                this.loadingSpinner.classList.remove('show');
                this.show({ type, title, text, timer: 3000 });
            }

            // Close animation
            close() {
                this.modal.classList.remove('show');
                this.clearTimers();
                this.currentCallback = null;
            }

            // Clear all timers
            clearTimers() {
                if (this.autoCloseTimer) {
                    clearTimeout(this.autoCloseTimer);
                    this.autoCloseTimer = null;
                }
            }

            // Outside click handler
            outsideClickHandler(e) {
                if (e.target === this.modal) {
                    this.close();
                }
            }
        }

        // Initialize CarAlert
        const CarSwal = new CarAlert();

        // Global functions to replace SweetAlert
        function showCarAlert(type, title, text, options = {}) {
            CarSwal.show({ type, title, text, ...options });
        }

        // Apply Coupon
        async function applyCoupon() {
            const input = document.getElementById('couponInput').value.trim();
            const totalAmount = parseFloat(document.getElementById('total-price')?.dataset.total || 0)
            const res = await fetch('/applycoupen', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    totalAmount,
                    input
                })
            });
            const data = await res.json();

            if (data.success) {
                // show the div only when success
                document.getElementById("couponDiv").style.display = "flex";

                showToast(data.success, 'success');

                const el = document.getElementById('total-price');
                el.dataset.total = data.Amount;
                el.textContent = "‚Çπ" + data.Amount.toLocaleString("en-IN");

                document.getElementById("coupenAppled").innerHTML =
                    "-‚Çπ" + data.Amount.toLocaleString("en-IN");

                const btn = document.querySelector(".coupenButton");
                btn.disabled = true;
                btn.textContent = "Coupon Applied";

            } else {
                // keep hidden if not success
                document.getElementById("couponDiv").style.display = "none";
            }

            if (data.fail) {
                showToast(data.fail, 'error');
            }
        }

        // Address Management
        let currentEditId = null;

        function updateSelectedAddress() {
            const select = document.getElementById('addressSelect');
            const selectedId = select.value;
            document.querySelectorAll('.address-details').forEach(el => {
                el.classList.add('hidden');
            });
            if (selectedId !== '0') {
                const selectedAddress = document.getElementById(`address-${selectedId}`);
                if (selectedAddress) {
                    selectedAddress.classList.remove('hidden');
                }
            }
        }

        // Radio Button Styling for Address Type
        function setupAddressTypeRadioButtons() {
            const radioButtons = document.querySelectorAll('input[name="formAddressType"]');

            radioButtons.forEach(input => {
                input.addEventListener('change', function () {
                    // Reset all radio button styles
                    document.querySelectorAll('input[name="formAddressType"]').forEach(radio => {
                        const label = radio.closest('label');
                        if (label) {
                            label.classList.remove('border-rc-red', 'bg-rc-red/5', 'text-rc-red');
                            label.classList.add('border-rc-border-gray');
                        }
                    });

                    // Style selected radio button
                    if (this.checked) {
                        const label = this.closest('label');
                        if (label) {
                            label.classList.remove('border-rc-border-gray');
                            label.classList.add('border-rc-red', 'bg-rc-red/5', 'text-rc-red');
                        }
                    }
                });
            });
        }

        // Setup input formatting
        function setupInputFormatting() {
            // Phone number formatting
            const phoneInputs = document.querySelectorAll('#formPhone, #formAltPhone');
            phoneInputs.forEach(input => {
                input.addEventListener('input', function (e) {
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
                });
            });

            // Pincode formatting
            const pinInput = document.getElementById('formPin');
            if (pinInput) {
                pinInput.addEventListener('input', function (e) {
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
                });
            }
        }

        // Reset Address Form
        function resetAddressForm() {
            document.getElementById('formName').value = '';
            document.getElementById('formPhone').value = '';
            document.getElementById('formAltPhone').value = '';
            document.getElementById('formPin').value = '';
            document.getElementById('formLocality').value = '';
            document.getElementById('formHouseNo').value = '';
            document.getElementById('formLandMark').value = '';
            document.getElementById('formCity').value = '';
            document.getElementById('formState').value = '';

            // Reset radio buttons
            const radioButtons = document.querySelectorAll('input[name="formAddressType"]');
            radioButtons.forEach(input => {
                input.checked = false;
                const label = input.closest('label');
                if (label) {
                    label.classList.remove('border-rc-red', 'bg-rc-red/5', 'text-rc-red');
                    label.classList.add('border-rc-border-gray');
                }
            });
        }

        function showAddAddressForm() {
            document.getElementById('addressForm').classList.remove('hidden');
            currentEditId = null;
            resetAddressForm();
            // Focus on first input
            setTimeout(() => {
                document.getElementById('formName').focus();
            }, 100);
        }

        function editSelectedAddress() {
            const select = document.getElementById('addressSelect');
            const selectedValue = select.value;
            if (selectedValue === '0') {
                showToast('Please select an address to edit', 'error');
                return;
            }
            const [userId, index] = selectedValue.split('-');
            window.location.href = `/editeaddress/${userId}`;
        }

        function cancelAddressForm() {
            document.getElementById('addressForm').classList.add('hidden');
            currentEditId = null;
            resetAddressForm();
        }

        // Updated Save Address Function with correct field IDs
        async function saveAddress() {
            // Get form values with CORRECT IDs matching the HTML
            const name = document.getElementById('formName').value.trim();
            const phoneNumber = document.getElementById('formPhone').value.trim();
            const altPhoneNumber = document.getElementById('formAltPhone').value.trim();
            const pincode = document.getElementById('formPin').value.trim(); // Fixed: was formPincode
            const locality = document.getElementById('formLocality').value.trim();
            const houseNo = document.getElementById('formHouseNo').value.trim(); // Fixed: was formAddress
            const landMark = document.getElementById('formLandMark').value.trim(); // Fixed: was formLandmark
            const city = document.getElementById('formCity').value.trim();
            const state = document.getElementById('formState').value;
            const addressTypeElement = document.querySelector('input[name="formAddressType"]:checked');

            // Validation
            if (!name) {
                showToast('Please enter your name', 'error');
                document.getElementById('formName').focus();
                return;
            }

            if (!phoneNumber) {
                showToast('Please enter your phone number', 'error');
                document.getElementById('formPhone').focus();
                return;
            }

            if (!/^[0-9]{10}$/.test(phoneNumber)) {
                showToast('Please enter a valid 10-digit phone number', 'error');
                document.getElementById('formPhone').focus();
                return;
            }

            if (altPhoneNumber && !/^[0-9]{10}$/.test(altPhoneNumber)) {
                showToast('Please enter a valid 10-digit alternate phone number', 'error');
                document.getElementById('formAltPhone').focus();
                return;
            }

            if (!pincode) {
                showToast('Please enter pincode', 'error');
                document.getElementById('formPin').focus();
                return;
            }

            if (!/^[0-9]{6}$/.test(pincode)) {
                showToast('Please enter a valid 6-digit pincode', 'error');
                document.getElementById('formPin').focus();
                return;
            }

            if (!locality) {
                showToast('Please enter locality/area', 'error');
                document.getElementById('formLocality').focus();
                return;
            }

            if (!houseNo) {
                showToast('Please enter house number/building', 'error');
                document.getElementById('formHouseNo').focus();
                return;
            }

            if (!city) {
                showToast('Please enter city', 'error');
                document.getElementById('formCity').focus();
                return;
            }

            if (!state) {
                showToast('Please select a state', 'error');
                document.getElementById('formState').focus();
                return;
            }

            if (!addressTypeElement) {
                showToast('Please select an address type', 'error');
                return;
            }

            const addressType = addressTypeElement.value;

            // Show loading state
            const saveBtn = document.getElementById('saveAddressBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            const addressData = {
                name,
                phoneNumber,
                altPhoneNumber,
                pincode,
                locality,
                houseNo,
                landMark,
                city,
                state,
                addressType
            };

            try {
                const response = await fetch('/addaddress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(addressData)
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Address saved successfully!', 'success');
                    cancelAddressForm();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.error || 'Failed to save address', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Network error. Please check your connection and try again.', 'error');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function removeSelectedAddress() {
            const select = document.getElementById('addressSelect');
            const selectedValue = select.value;
            if (selectedValue === '0') {
                showToast('Please select an address to remove', 'error');
                return;
            }
            if (!confirm('Are you sure you want to remove this address?')) return;
            const [userId, addressIndex] = selectedValue.split('-');
            try {
                const response = await fetch('/removeaddresscheckout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, addressIndex })
                });
                const data = await response.json();
                if (data.success) {
                    select.remove(select.selectedIndex);
                    const addressElement = document.getElementById(`address-${selectedValue}`);
                    if (addressElement) addressElement.remove();
                    select.selectedIndex = 0;
                    updateSelectedAddress();
                    showToast('Address removed successfully!');
                } else {
                    showToast(data.error || 'Failed to remove address', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Something went wrong while removing the address.', 'error');
            }
        }

        // ---------------- All Coupons: data model ----------------
        // Replace with server-fed data as needed:
        const rawCoupons = JSON.parse('<%- JSON.stringify(coupen)%>');

        // Step 2: convert to your frontend format
        const availableCoupons = rawCoupons.map(c => {
            let label = "";
            if (c.couponType === "percentage") {
                label = `${c.couponAmount}% OFF`;
            } else {
                label = `‚Çπ${c.couponAmount} OFF`;
            }

            return {
                code: c.couponCode,
                label: label,
                description: c.description,
                status: c.status === "active" ? "active" : "expired"
            };
        });

        console.log("Coupons from backend:", availableCoupons);

        // Utility: Fill coupon input and focus
        function fillCoupon(code) {
            const input = document.getElementById('couponInput');
            if (!input) return;
            input.value = code;
            input.focus();
        }

        // Renderer for the horizontal chips
        function renderAllCoupons() {
            const scroller = document.getElementById('couponsScroller');
            if (!scroller) return;

            scroller.innerHTML = '';

            availableCoupons.forEach(cpn => {
                const isDisabled = cpn.status !== 'active';
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = [
                    'flex-none',
                    'px-3', 'py-2',
                    'rounded-md',
                    'shadow-sm',
                    'text-xs',
                    'font-semibold',
                    'border',
                    isDisabled
                        ? 'bg-white text-rc-gray border-rc-border-gray cursor-not-allowed opacity-60'
                        : 'bg-white text-rc-red border-rc-yellow hover:bg-rc-yellow/10 hover:shadow',
                    'whitespace-nowrap',
                    'transition-all'
                ].join(' ');

                chip.setAttribute('aria-label', `${cpn.code} - ${cpn.description || cpn.label}`);
                chip.dataset.code = cpn.code;

                chip.innerHTML = `
      <span class="inline-flex items-center gap-2">
        <span class="inline-block bg-rc-yellow text-black text-[10px] px-1.5 py-0.5 rounded">COUPON</span>
        <span>${cpn.code}</span>
        <span class="text-rc-gray font-normal hidden sm:inline">‚Ä¢ ${cpn.label}</span>
      </span>
    `;

                if (!isDisabled) {
                    chip.addEventListener('click', () => {
                        // Mark selected
                        document.querySelectorAll('#couponsScroller button').forEach(b => b.classList.remove('ring-2', 'ring-white'));
                        chip.classList.add('ring-2', 'ring-white');

                        // Fill input and trigger apply
                        fillCoupon(cpn.code);

                    });
                }

                scroller.appendChild(chip);
            });

            enableHorizontalDragScroll(scroller);
        }

        // Horizontal drag/scroll (mouse + touch)
        function enableHorizontalDragScroll(container) {
            let isDown = false;
            let startX = 0;
            let scrollLeft = 0;

            container.addEventListener('mousedown', (e) => {
                isDown = true;
                container.classList.add('cursor-grabbing');
                startX = e.pageX - container.offsetLeft;
                scrollLeft = container.scrollLeft;
            });

            container.addEventListener('mouseleave', () => {
                isDown = false;
                container.classList.remove('cursor-grabbing');
            });

            container.addEventListener('mouseup', () => {
                isDown = false;
                container.classList.remove('cursor-grabbing');
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const walk = (x - startX) * 1.2;
                container.scrollLeft = scrollLeft - walk;
            });

            // Touch
            let tStartX = 0;
            let tScrollLeft = 0;
            container.addEventListener('touchstart', (e) => {
                tStartX = e.touches[0].pageX - container.offsetLeft;
                tScrollLeft = container.scrollLeft;
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                const x = e.touches[0].pageX - container.offsetLeft;
                const walk = (x - tStartX) * 1.2;
                container.scrollLeft = tScrollLeft - walk;
            }, { passive: true });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            renderAllCoupons();
            setupAddressTypeRadioButtons();
            setupInputFormatting();

            // Setup button event listeners
            const saveBtn = document.getElementById('saveAddressBtn');
            const cancelBtn = document.getElementById('cancelAddressBtn');

            if (saveBtn) {
                saveBtn.addEventListener('click', saveAddress);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelAddressForm);
            }
        });

        // Optional: when a coupon is applied successfully, highlight it if present
        const originalApplyCoupon = window.applyCoupon;
        window.applyCoupon = function () {
            // Call existing logic
            originalApplyCoupon();

            // Post-apply UI sync
            try {
                const input = document.getElementById('couponInput');
                const code = input?.value?.trim().toUpperCase() || '';
                if (!code) return;

                const chips = Array.from(document.querySelectorAll('#couponsScroller button'));
                chips.forEach(chip => chip.classList.remove('ring-2', 'ring-white'));
                const match = chips.find(chip => chip.dataset.code?.toUpperCase() === code);
                if (match) {
                    match.classList.add('ring-2', 'ring-white');
                }
            } catch (_) { }
        };

        // Place Order
        async function placetheorder() {
            const productId = document.getElementById('peoductId')?.dataset.id;
            const select = document.getElementById('addressSelect');
            const selectedValue = select.value;
            if (selectedValue === '0') {
                showToast('Please select an address', 'error');
                return;
            }
            const [addressId, addressIndex] = selectedValue.split('-');
            const total = document.getElementById('total-price').dataset.total;
            const discount = document.getElementById('discount-text')?.dataset.discountamount || 0;
            const totalitems = document.getElementById('totalitems').dataset.items;
            const subtotal = document.getElementById('subtotal').dataset.subtotal;
            const Shipping = document.getElementById('ShippingCharge').dataset.shippingcharge;
            const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
            const couponName = document.getElementById('couponInput').value.trim();
            console.log(total)
            if (!paymentMethod) {
                showToast('Please select a payment method', 'error');
                return;
            }
            const orderdperson = document.getElementById('recipientName').value;
            if (!orderdperson) {
                showToast('Please enter recipient name', 'error');
                return;
            }

            try {
                const res = await fetch('/orderorderDerailsPost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        addressId,
                        addressIndex,
                        paymentMethod,
                        Shipping,
                        subtotal,
                        totalitems,
                        discount,
                        total,
                        productId,
                        orderdperson,
                        couponName
                    })
                });
                const data = await res.json();
                if (paymentMethod === 'razorpay' && data.orderId) {
                    const userEmail = document.getElementById('userEmail')?.value || 'customer@example.com';
                    const userPhone = document.getElementById('userPhone')?.value || '9999999999';
                    const options = {
                        key: data.key,
                        amount: data.amount,
                        currency: data.currency,
                        name: 'RC WORLD',
                        description: 'Order Payment',
                        order_id: data.orderId,
                        handler: async function (response) {
                            const verify = await fetch('/verifyrazorpay', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(response)
                            });
                            const result = await verify.json();
                            if (result.success) {
                                const orderRes = await fetch('/completerazorpay', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        addressId,
                                        addressIndex,
                                        paymentMethod,
                                        Shipping,
                                        subtotal,
                                        totalitems,
                                        discount,
                                        total,
                                        productId,
                                        orderdperson,
                                        couponName,
                                        razorpayPaymentId: response.razorpay_payment_id,
                                        razorpayOrderId: response.razorpay_order_id,
                                        razorpaySignature: response.razorpay_signature
                                    })
                                });
                                const orderData = await orderRes.json();
                                if (orderData.success) {
                                    CarSwal.show({
                                        type: 'success',
                                        title: 'Success!',
                                        text: 'Payment successful! Order placed.',
                                        showCancelButton: false,
                                        confirmButtonText: 'OK',
                                        callback: (result) => {
                                            if (result.isConfirmed) {
                                                window.location.href = `/orderdetails/${orderData.orderId}`;
                                            }
                                        }
                                    });
                                } else {
                                    showToast(orderData.failed || 'Order creation failed', 'error');
                                }
                            } else {
                                showToast('Payment verification failed', 'error');
                            }
                        },
                        prefill: {
                            name: orderdperson,
                            email: userEmail,
                            contact: userPhone
                        },
                        theme: {
                            color: '#df2f2f' // Updated to rc-red
                        }
                    };
                    const rzp = new Razorpay(options);
                    rzp.on('payment.failed', function (response) {
                        showToast('Payment failed: ' + response.error.description, 'error');
                    });
                    rzp.open();
                    return;
                }
                if (data.success) {
                    CarSwal.show({
                        type: 'success',
                        title: 'Success!',
                        text: 'Order placed successfully.',
                        showCancelButton: false,
                        confirmButtonText: 'OK',
                        callback: (result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/orderdetails/${data.orderId}`;
                            }
                        }
                    });
                } else {
                    showToast(data.failed || 'Something went wrong', 'error');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                showToast('Server error. Please try again.', 'error');
            }
        }

        // Add to Cart (for Recommended Products)
        async function addToCart(productId) {
            try {
                const res = await fetch('/postcart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, qty: 1 })
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    showToast('Item added to cart!');
                    const cartBadge = document.querySelector('.cart-badge');
                    cartBadge.textContent = parseInt(cartBadge.textContent || 0) + 1;
                } else {
                    showToast(result.message || 'Failed to add to cart', 'error');
                }
            } catch (err) {
                console.error('Add to cart failed:', err);
                showToast('Invalid request. Please login and try again.', 'error');
            }
        }

        // Carousel Scroll
        function scrollCarousel(carouselId, scrollAmount) {
            const carousel = document.getElementById(carouselId);
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }

        // Carousel Drag
        const carousel = document.getElementById('recommendCarousel');
        if (carousel) {
            let isDragging = false;
            let startX, scrollLeft;

            carousel.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
                carousel.style.cursor = 'grabbing';
            });

            carousel.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - carousel.offsetLeft;
                const walk = (x - startX) * 1.5;
                carousel.scrollLeft = scrollLeft - walk;
            });

            carousel.addEventListener('mouseup', () => {
                isDragging = false;
                carousel.style.cursor = 'grab';
            });

            carousel.addEventListener('mouseleave', () => {
                isDragging = false;
                carousel.style.cursor = 'grab';
            });

            carousel.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].pageX - carousel.offsetLeft;
                scrollLeft = carousel.scrollLeft;
            });

            carousel.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX - carousel.offsetLeft;
                const walk = (x - startX) * 1.5;
                carousel.scrollLeft = scrollLeft - walk;
            });

            carousel.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        // Close animation function
        function closeCarAnimation() {
            CarSwal.close();
        }

        // Legacy function for backward compatibility
        function Submit() {
            showCarAlert('success', 'üèÅ Race Complete!', 'The car has successfully reached its destination!');
        }

        // Keyboard event handler
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeCarAnimation();
            }
        });

        // Initialize Address Display
        updateSelectedAddress();
    </script>

    <style>
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</body>

</html>